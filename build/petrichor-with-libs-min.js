/*
Copyright Â© 2014 Florent 'flure' CURE <florent.cure@gmail.com>
This work is free. You can redistribute it and/or modify it under the
terms of the Do What The Fuck You Want To Public License, Version 2,
as published by Sam Hocevar. See http://www.wtfpl.net/ for more details.
*/
"use strict";function countResources(){var a,b=0;for(a in PETRICHOR.resources.meshes)PETRICHOR.resources.meshes.hasOwnProperty(a)&&b++;for(a in PETRICHOR.resources.programs)PETRICHOR.resources.programs.hasOwnProperty(a)&&b++;for(a in PETRICHOR.resources.textures)PETRICHOR.resources.textures.hasOwnProperty(a)&&b++;return PETRICHOR.resources.music&&b++,b}var PETRICHOR=PETRICHOR||{};PETRICHOR.Camera=function(){return this.matrixUniforms={},this.fovy=45,this.near=.1,this.far=2,this.ratio=4/3,this.position=[0,0,3],this.center=[0,0,0],this.up=[0,1,0],this.projectionMatrix=mat4.create(),this.viewMatrix=mat4.create(),this.setPerspective=function(){return mat4.perspective(this.projectionMatrix,this.fovy,this.ratio,this.near,this.far),this},this.setOrthographic=function(a,b,c,d){return mat4.ortho(this.projectionMatrix,a,b,c,d,this.near,this.far),this},this.lookAt=function(){return mat4.lookAt(this.viewMatrix,this.position,this.center,this.up),this},this.setUniform=function(a,b){return this.matrixUniforms[a]=b,this},this.upload=function(a,b){var c=b.getTransformationMatrix(),d=mat4.create(),e=mat3.create();mat4.multiply(d,this.projectionMatrix,this.viewMatrix),mat4.multiply(d,d,c),mat3.normalFromMat4(e,c),a.setUniformMatrix3fv(this.matrixUniforms.normalMatrix,e),a.setUniformMatrix4fv(this.matrixUniforms.modelMatrix,c),a.setUniformMatrix4fv(this.matrixUniforms.projectionMatrix,this.projectionMatrix),a.setUniformMatrix4fv(this.matrixUniforms.viewMatrix,this.viewMatrix),a.setUniformMatrix4fv(this.matrixUniforms.mvpMatrix,d),a.setUniform1f(this.matrixUniforms.near,this.near),a.setUniform1f(this.matrixUniforms.far,this.far)},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.effects=[],PETRICHOR.addEffect=function(a){PETRICHOR.effects.push(a)},PETRICHOR.time=0,PETRICHOR.initEffects=function(){var a=0,b=null;for(a=0;a<PETRICHOR.effects.length;a++)b=PETRICHOR.effects[a],b.init();PETRICHOR.time=(new Date).getTime()},PETRICHOR.playEffects=function(a){var b,c,d,e=0,f=a||(new Date).getTime()-PETRICHOR.time,g=null;for(e=0;e<PETRICHOR.effects.length;e++)g=PETRICHOR.effects[e],b=g.startTime||0,c=g.endTime||99999,d=g.loop||!1,f>=b&&(d||c>=f)&&g.update(f)},PETRICHOR.start=function(){PETRICHOR.initEffects(),function a(){PETRICHOR.play(),window.requestAnimFrame(a,document)}()},PETRICHOR.play=function(a){var b=document.getElementById("chkFps"),c=document.getElementById("fps");void 0!=b&&void 0!=c&&(document.getElementById("chkFps").checked?PETRICHOR.showFps("fps"):c.innerHTML=""),PETRICHOR.playEffects(a)};var PETRICHOR=PETRICHOR||{};PETRICHOR.Fbo=function(a,b){return this.frameBuffer=null,this.colorBuffer=null,this.depthBuffer=null,this.width=a,this.height=b,this.build=function(a){var b=PETRICHOR.gl;if(this.frameBuffer=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.getError()!=b.NO_ERROR&&alert("Error in gl.bindFramebuffer"),this.colorBuffer=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.colorBuffer),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGB,this.width,this.height,0,b.RGB,b.UNSIGNED_BYTE,null),b.getError()!=b.NO_ERROR&&alert("Error in creating the fbo color buffer"),a){var c=PETRICHOR.getExtension("WEBGL_depth_texture");if(null==c)return void alert("WEBGL_depth_texture extension required.\nPlease switch to a modern browser.");this.depthBuffer=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.depthBuffer),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.DEPTH_COMPONENT,this.width,this.height,0,b.DEPTH_COMPONENT,b.UNSIGNED_SHORT,null),b.getError()!=b.NO_ERROR&&alert("Error in creating the fbo depth buffer")}else this.depthBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.depthBuffer),b.getError()!=b.NO_ERROR&&alert("Error in gl.bindRenderbuffer"),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);b.getError()!=b.NO_ERROR&&alert("Error in gl.renderbufferStorage"),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.colorBuffer,0),b.getError()!=b.NO_ERROR&&alert("Error attaching color buffer"),a?b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.TEXTURE_2D,this.depthBuffer,0):b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depthBuffer),b.getError()!=b.NO_ERROR&&alert("Error attaching depth buffer"),b.checkFramebufferStatus(b.FRAMEBUFFER)!=b.FRAMEBUFFER_COMPLETE&&alert("Error in FBO creation"),b.bindTexture(b.TEXTURE_2D,null),b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null)},this.begin=function(){var a=PETRICHOR.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.getError()!=a.NO_ERROR&&alert("Error in Fbo.begin")},this.end=function(){var a=PETRICHOR.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),a.getError()!=a.NO_ERROR&&alert("Error in Fbo.end")},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.Light=function(){return this.color=vec3.fromValues(1,1,1),this.position=vec3.fromValues(0,0,0),this.radius=2,this.power=1,this.uniforms={color:"",position:"",radius:"",power:""},this.setUniforms=function(a){return a.hasOwnProperty("color")&&a.color&&(this.uniforms.color=a.color),a.hasOwnProperty("position")&&a.position&&(this.uniforms.position=a.position),a.hasOwnProperty("radius")&&a.radius&&(this.uniforms.radius=a.radius),a.hasOwnProperty("power")&&a.power&&(this.uniforms.power=a.power),this},this.uploadParams=function(a){this.uniforms.color&&a.setUniform3fv(this.uniforms.color,this.color),this.uniforms.position&&a.setUniform3fv(this.uniforms.position,this.position),this.uniforms.radius&&a.setUniform1f(this.uniforms.radius,this.radius),this.uniforms.power&&a.setUniform1f(this.uniforms.power,this.power)},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.Mesh=function(a,b){return this.vertices=null,this.normals=null,this.textureCoords=null,this.indices=null,this.transform=new PETRICHOR.Transform,this.textures=[],this.isDynamic=a||!1,this.vertexBuffer=null,this.normalBuffer=null,this.textureCoordsBuffer=null,this.indexBuffer=null,this.attributeNames={},b&&this.set(b),this.set=function(a){return a.hasOwnProperty("vertices")&&(this.vertices=new Float32Array(a.vertices)),a.hasOwnProperty("normals")&&(this.normals=new Float32Array(a.normals)),a.hasOwnProperty("uv")&&(this.textureCoords=new Float32Array(a.uv)),a.hasOwnProperty("indices")&&(this.indices=new Uint16Array(a.indices)),this},this.build=function(){var a=PETRICHOR.gl;return this.vertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.vertices),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.itemCount=this.vertices.length/3,this.normals&&(this.normalBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.normals),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.normalBuffer.itemSize=3,this.normalBuffer.itemCount=this.normals.length/3),this.textureCoords&&(this.textureCoordsBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.textureCoordsBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.textureCoords),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.textureCoordsBuffer.itemSize=2,this.textureCoordsBuffer.itemCount=this.textureCoords.length/2),this.indices&&(this.indexBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.indexBuffer.itemSize=1,this.indexBuffer.itemCount=this.indices.length),this},this.render=function(a,b){var c,d,e=PETRICHOR.gl,f=-1,g=-1,h=-1;a.enable(),b&&b.upload(a,this.transform);try{for(c=0;c<this.textures.length;c++)d=this.textures[c],d.texture.enable(d.unit),a.setUniform1i(d.sampler,d.unit)}catch(i){console.log(i)}return this.attributeNames.hasOwnProperty("vertex")&&(f=a.attributes.get(this.attributeNames.vertex)),this.attributeNames.hasOwnProperty("normal")&&(g=a.attributes.get(this.attributeNames.normal)),this.attributeNames.hasOwnProperty("uv")&&(h=a.attributes.get(this.attributeNames.uv)),e.enableVertexAttribArray(f),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(f,this.vertexBuffer.itemSize,e.FLOAT,!1,0,0),this.attributeNames.hasOwnProperty("normal")&&(e.enableVertexAttribArray(g),e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer),e.vertexAttribPointer(g,this.normalBuffer.itemSize,e.FLOAT,!1,0,0)),this.attributeNames.hasOwnProperty("uv")&&(e.enableVertexAttribArray(h),e.bindBuffer(e.ARRAY_BUFFER,this.textureCoordsBuffer),e.vertexAttribPointer(h,this.textureCoordsBuffer.itemSize,e.FLOAT,!1,0,0)),this.indices?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.drawElements(e.TRIANGLES,this.indexBuffer.itemCount,e.UNSIGNED_SHORT,0)):e.drawArrays(e.TRIANGLES,0,this.vertices.length/3),this},this.setAttributeName=function(a,b){return this.attributeNames[a]=b,this},this.setTexture=function(a,b,c){var d={unit:a,texture:b,sampler:c};return this.textures.push(d),this},this},PETRICHOR.Transform=function(){return this.translation=vec3.create(),this.rotation=vec3.create(),this.scale=vec3.fromValues(1,1,1),this.transformMatrix=mat4.create(),this.setTranslation=function(a,b,c){return this.translation[0]=a,this.translation[1]=b,this.translation[2]=c,this},this.setRotation=function(a,b,c){return this.rotation[0]=a,this.rotation[1]=b,this.rotation[2]=c,this},this.setScale=function(a,b,c){return this.scale[0]=a,this.scale[1]=b,this.scale[2]=c,this},this.getTransformationMatrix=function(){var a=(mat4.create(),mat4.create(),mat4.create()),b=(quat.create(),quat.create(),quat.create(),quat.create(),quat.create());return quat.identity(b),quat.rotateX(b,b,this.rotation[0]),quat.rotateY(b,b,this.rotation[1]),quat.rotateZ(b,b,this.rotation[2]),quat.normalize(b,b),mat4.fromRotationTranslation(this.transformMatrix,b,this.translation),mat4.scale(a,a,this.scale),mat4.multiply(this.transformMatrix,this.transformMatrix,a),this.transformMatrix},this},PETRICHOR.loadMesh=function(a){function b(a,b){var c=JSON.parse(b.responseText);a.mesh=new PETRICHOR.Mesh,a.mesh.set(c),a.mesh.isDynamic=c.isDynamic,a.mesh.build(),PETRICHOR.resources.loadCounter++}var c=new XMLHttpRequest;c.open("GET",a.path),c.overrideMimeType("text/plain"),c.onreadystatechange=function(a,c){return function(){4==c.readyState&&b(a,c)}}(a,c),c.send()};var PETRICHOR=PETRICHOR||{};PETRICHOR.music=null,PETRICHOR.loadMusic=function(a){var b=!1,c=!1;if(console.log("Loading music..."),a){if(!a.ogg&&!a.mp3)return void console.log("No path for music.");a.audio=new Audio,c=!(!a.audio.canPlayType||!a.audio.canPlayType("audio/mpeg;").replace(/no/,"")),b=!(!a.audio.canPlayType||!a.audio.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")),a.hasOwnProperty("mp3")&&c?(a.audio.src=a.mp3,console.log("Music loaded: MP3 format.")):a.hasOwnProperty("ogg")&&b?(a.audio.src=a.ogg,console.log("Music loaded: OGG format.")):console.log("Music not loaded: unsupported format."),PETRICHOR.music=PETRICHOR.resources.music.audio,PETRICHOR.resources.loadCounter++}};var PETRICHOR=PETRICHOR||{};PETRICHOR.Program=function(){function a(a,b){var c=PETRICHOR.gl,d=0,e="";if(b){if("vertex"===a)d=c.createShader(c.VERTEX_SHADER);else{if("fragment"!==a)return 0;d=c.createShader(c.FRAGMENT_SHADER)}return c.shaderSource(d,b),c.compileShader(d),c.getShaderParameter(d,c.COMPILE_STATUS)?d:(e=c.getShaderInfoLog(d),e&&(window.alert("Error in the "+a+" shader.\nCheck console to see details."),console.log(e)),null)}}var b=PETRICHOR.gl;return this.id=null,this.vertexId=null,this.fragmentId=null,this.vertexSrc="",this.fragmentSrc="",this.uniforms=new PETRICHOR.Uniforms(this),this.attributes=new PETRICHOR.Attributes(this),this.setSource=function(a,b){this.vertexSrc=a,this.fragmentSrc=b},this.build=function(){var b=PETRICHOR.gl;return this.id=b.createProgram(),this.vertexId=a("vertex",this.vertexSrc),this.fragmentId=a("fragment",this.fragmentSrc),b.attachShader(this.id,this.vertexId),b.attachShader(this.id,this.fragmentId),b.linkProgram(this.id),b.getProgramParameter(this.id,b.LINK_STATUS)||window.alert("Could not initialise shader"),this},this.enable=function(){var a=PETRICHOR.gl;return this.id||this.build(),a.useProgram(this.id),this},this.disable=function(){var a=PETRICHOR.gl;return a.useProgram(null),this},this.setU={mat3:function(){return b.uniformMatrix3fv}(),mat4:function(){return b.uniformMatrix4fv}(),"int":function(){return b.uniform1i}()},this.setUniformMatrix3fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniformMatrix3fv(d,!1,b):this},this.setUniformMatrix4fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniformMatrix4fv(d,!1,b):this},this.setUniform1i=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform1i(d,b):this},this.setUniform2fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform2fv(d,b):this},this.setUniform3fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform3fv(d,b):this},this.setUniform1f=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform1f(d,b):this},this},PETRICHOR.Uniforms=function(a){return this.program=a,this.bindings={},this.get=function(b){var c=PETRICHOR.gl;return this.bindings[b]&&this.bindings.hasOwnProperty(b)&&-1!==this.bindings[b]||(a.enable(),this.bindings[b]=c.getUniformLocation(this.program.id,b)),this.bindings[b]},this},PETRICHOR.Attributes=function(a){return this.program=a,this.bindings={},this.get=function(b){var c=PETRICHOR.gl;return this.bindings[b]&&this.bindings.hasOwnProperty(b)&&-1!==this.bindings[b]||(a.enable(),this.bindings[b]=c.getAttribLocation(this.program.id,b)),this.bindings[b]},this},PETRICHOR.loadProgram=function(a){function b(a){return console.log("finalizeProgramLoad"),a.program.fragmentSrc&&a.program.vertexSrc?(a.program.build(),void PETRICHOR.resources.loadCounter++):void setTimeout(function(){b(a)},50)}function c(a,b,c){switch(c){case"fragment":a.program.fragmentSrc=b.responseText;break;case"vertex":a.program.vertexSrc=b.responseText}}var d=a.vertexPath,e=a.fragmentPath,f=new XMLHttpRequest,g=new XMLHttpRequest;a.program=new PETRICHOR.Program,f.open("GET",d),f.overrideMimeType("text/plain"),f.onreadystatechange=function(a,b){return function(){4==b.readyState&&c(a,b,"vertex")}}(a,f),g.open("GET",e),g.overrideMimeType("text/plain"),g.onreadystatechange=function(a,b){return function(){4==b.readyState&&c(a,b,"fragment")}}(a,g),f.send(),g.send(),b(a)};var PETRICHOR=PETRICHOR||{};PETRICHOR.SyncManager=function(a,b,c,d,e){return this.BPM=b,this.ROWS_PER_BEAT=c,this.ROW_RATE=this.BPM/60*this.ROWS_PER_BEAT,this.rocketFile=a,this.editMode=d,this.port=e,this.device=new JSRocket.SyncDevice,this.tracks={},this.trackNames=[],this.row=0,this.onReady=function(){PETRICHOR.initEffects(),this.setTracks(this.trackNames),this.editMode?(PETRICHOR.music.pause(),PETRICHOR.music.currentTime=this.row/ROW_RATE):(this.render(),PETRICHOR.music.play())},this.onUpdate=function(a){isNaN(a)||(this.row=a)},this.onPlay=function(){PETRICHOR.music.currentTime=this.row/this.ROW_RATE,PETRICHOR.music.play(),this.render(),console.log("play at row "+this.row+" ["+PETRICHOR.music.currentTime+"ms]")},this.onPause=function(){this.row=PETRICHOR.music.currentTime*this.ROW_RATE,window.cancelAnimationFrame(this.render,document),PETRICHOR.music.pause(),console.log("pause at row "+this.row+" ["+PETRICHOR.music.currentTime+"ms]")},this.init=function(){this.editMode?(this.port&&this.device.setConfig({socketUrl:"ws://localhost:"+this.port}),this.device.init()):(this.device.setConfig({rocketXML:this.rocketFile}),this.device.init("demo"));this.device.on("ready",function(){this.onReady()}.bind(this)),this.device.on("update",function(a){this.onUpdate(a)}.bind(this)),this.device.on("play",function(){this.onPlay()}.bind(this)),this.device.on("pause",function(){this.onPause()}.bind(this))},this.getTrack=function(a){return this.tracks[a].getValue(this.row)},this.setTracks=function(a){var b;for(b=0;b<a.length;b++)this.tracks[a[b]]=this.device.getTrack(a[b])},this.render=function(){PETRICHOR.music.paused===!1&&(this.row=PETRICHOR.music.currentTime*this.ROW_RATE,this.device.update(this.row)),PETRICHOR.play(PETRICHOR.music.currentTime),this.editMode&&PETRICHOR.music.paused!==!1?window.cancelAnimationFrame(function(){this.render()}.bind(this),document):window.requestAnimationFrame(function(){this.render()}.bind(this),document)},this},PETRICHOR.sync=null,PETRICHOR.initSync=function(a,b,c,d,e,f){return PETRICHOR.sync=new PETRICHOR.SyncManager(a,b,c,d,e),PETRICHOR.sync.trackNames=f,PETRICHOR.sync.init(),PETRICHOR.sync};var PETRICHOR=PETRICHOR||{};PETRICHOR.Texture2D=function(){var a=PETRICHOR.gl;return this.image=null,this.filter={min:a.LINEAR_MIPMAP_LINEAR,mag:a.LINEAR},this.wrap={s:a.CLAMP_TO_EDGE,t:a.CLAMP_TO_EDGE},this.id=null,this.build=function(){var a=PETRICHOR.gl;return this.id=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.id),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.image),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.filter.min),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,this.filter.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,this.wrap.s),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,this.wrap.t),(this.filter.min==a.LINEAR_MIPMAP_NEAREST||this.filter.min==a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(a.TEXTURE_2D),this},this.enable=function(b){return a.activeTexture(a.TEXTURE0+b),a.bindTexture(a.TEXTURE_2D,this.id),this},this.disable=function(){return a.bindTexture(a.TEXTURE_2D,null),this},this},PETRICHOR.loadTexture2D=function(a){function b(a){try{a.build(),PETRICHOR.resources.loadCounter++}catch(b){console.log(b)}}var c=new PETRICHOR.Texture2D;c.image=new Image,a.hasOwnProperty("filter")&&a.filter&&(c.filter=a.filter),a.hasOwnProperty("wrap")&&a.wrap&&(c.wrap=a.wrap),c.image.onload=function(){b(c)},c.image.src=a.path,c.image.complete&&b(c),a.texture=c};var PETRICHOR=PETRICHOR||{};PETRICHOR.FullscreenQuad=function(a){return this.mesh=new PETRICHOR.Mesh,this.mesh.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0],this.mesh.textureCoords=[0,0,1,0,1,1,0,0,1,1,0,1],this.mesh.build(),this.program=new PETRICHOR.Program,a&&(this.program.vertexSrc="precision highp float;\nattribute vec3 aVertex;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n	vTexCoord = aTexCoord;\n	gl_Position = vec4(aVertex, 1.0);\n}",this.program.fragmentSrc="precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main()\n{\n	gl_FragColor = texture2D(uTexture, vTexCoord);\n}",this.program.build(),this.mesh.setAttributeName("vertex","aVertex"),this.mesh.setAttributeName("uv","aTexCoord")),this.setShaders=function(a,b){this.program.vertexSrc=a,this.program.fragmentSrc=b,this.program.build()},this.render=function(a){var b,c,d=PETRICHOR.gl;if(this.program.enable(),a)for(b=0;b<a.length;b++)c=a[b],this.program.setUniform1i(c.sampler,b),d.activeTexture(d.TEXTURE0+b),d.bindTexture(d.TEXTURE_2D,c.id);this.mesh.render(this.program),this.program.disable()},this},PETRICHOR.createCube=function(){var a=new PETRICHOR.Mesh;return a.vertices=[-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,-1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,-1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,1],a.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],a.textureCoords=[0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1],a.build(),a},PETRICHOR.createUvSphere=function(a,b,c){function d(b,c){var d=1/a;e.vertices.push(b[0]),e.vertices.push(b[1]),e.vertices.push(b[2]),e.normals.push(b[0]*d),e.normals.push(b[1]*d),e.normals.push(b[2]*d),e.textureCoords.push(c[0]),e.textureCoords.push(c[1])}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=Math.sin,w=Math.cos,x=Math.PI,y=x/2;for(e=new PETRICHOR.Mesh,e.vertices=[],e.normals=[],e.textureCoords=[],r=-x/(b-1),s=2*x/(c-1),q=0,n=0;c-1>n;n++){for(p=y,u=q+s,o=0;b-1>o;o++)t=p+r,f=[a*w(p)*w(q),a*v(p),a*w(p)*v(q)],j=[(p+y)/x,q/(2*x)],g=[a*w(t)*w(q),a*v(t),a*w(t)*v(q)],k=[(t+y)/x,q/(2*x)],h=[a*w(t)*w(u),a*v(t),a*w(t)*v(u)],l=[(t+y)/x,u/(2*x)],d(f,j),d(g,k),d(h,l),o>0&&b-1>o&&(i=[a*w(p)*w(u),a*v(p),a*w(p)*v(u)],m=[(p+y)/x,u/(2*x)],d(f,j),d(h,l),d(i,m)),p+=r;q+=s}return e.build(),e},PETRICHOR.renderText=function(a,b,c,d,e,f){var g,h=new PETRICHOR.Texture2D,i=null,j=null;for(i=document.createElement("canvas"),i.id="tmpFontCanvas",i.style.border="none;",i.width=a,i.height=a,j=i.getContext("2d"),j.clearRect(0,0,a,a),j.fillStyle=e,j.strokeStyle=f,j.font=d,g=0;g<b.length;g++)j.fillText(b[g],0,c*(g+1)),f&&j.strokeText(b[g],0,c*(g+1));return h.image=i,h.build(),i=null,h},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),window.clientWidth=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth},window.clientHeight=function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight};var PETRICHOR=PETRICHOR||{};PETRICHOR.width=640,PETRICHOR.height=480,PETRICHOR.mainCanvas=null,PETRICHOR.gl=null,PETRICHOR.init=function(a){function b(){var a=PETRICHOR.width/PETRICHOR.height,b=window.clientWidth(),c=Math.round(window.clientWidth()/a),d={width:b,height:c};return d.height=d.width/a,d.height>c&&(d.height=c-8,d.width=Math.round(d.height*a)),d}function c(){var a=b();PETRICHOR.mainCanvas.style.width=a.width+"px",PETRICHOR.mainCanvas.style.height=a.height+"px",PETRICHOR.mainCanvas.style.position="absolute",PETRICHOR.mainCanvas.style.top=Math.round((window.clientHeight()-a.height)/2)-1+"px",PETRICHOR.mainCanvas.style.left=Math.round((window.clientWidth()-a.width)/2)-1+"px"}function d(a){console.log("Creating canvas..."),PETRICHOR.width=a.width,PETRICHOR.height=a.height,PETRICHOR.mainCanvas=document.createElement("canvas"),PETRICHOR.mainCanvas.id="mainCanvas",PETRICHOR.mainCanvas.style.border="none;",PETRICHOR.mainCanvas.width=PETRICHOR.width,PETRICHOR.mainCanvas.height=PETRICHOR.height,c(),window.onresize=c,document.body.appendChild(PETRICHOR.mainCanvas),console.log("Canvas created.")}function e(){console.log("Creating WebGL context...");try{PETRICHOR.gl=PETRICHOR.mainCanvas.getContext("webgl"),PETRICHOR.gl.viewportWidth=PETRICHOR.mainCanvas.width,PETRICHOR.gl.viewportHeight=PETRICHOR.mainCanvas.height}catch(a){}if(!PETRICHOR.gl)try{PETRICHOR.gl=PETRICHOR.mainCanvas.getContext("experimental-webgl"),PETRICHOR.gl.viewportWidth=PETRICHOR.mainCanvas.width,PETRICHOR.gl.viewportHeight=PETRICHOR.mainCanvas.height}catch(a){}PETRICHOR.gl?console.log("WebGL context created."):window.alert("Could not initialize WebGL, sorry :-(")}d(a),e()},PETRICHOR.resources={textures:{},programs:{},meshes:{},music:null,loadCounter:0},PETRICHOR.setMusic=function(a,b){PETRICHOR.resources.music={ogg:a,mp3:b}},PETRICHOR.addMesh=function(a,b){PETRICHOR.resources.meshes[a]={path:b}},PETRICHOR.addProgram=function(a,b,c){PETRICHOR.resources.programs[a]={vertexPath:b,fragmentPath:c}},PETRICHOR.addTexture=function(a,b,c,d){PETRICHOR.resources.textures[a]={path:b,filter:c,wrap:d}},PETRICHOR.addResources=function(a){var b,c;for(b=0;b<a.length;b++)switch(c=a[b],c.type){case"music":PETRICHOR.setMusic(c.ogg,c.mp3);break;case"mesh":PETRICHOR.addMesh(c.name,c.path);break;case"program":PETRICHOR.addProgram(c.name,c.vertexPath,c.fragmentPath);break;case"texture":PETRICHOR.addTexture(c.name,c.path,c.filter,c.wrap)}},PETRICHOR.loadResources=function(){var a,b;console.log("Loading meshes...");for(a in PETRICHOR.resources.meshes)PETRICHOR.resources.meshes.hasOwnProperty(a)&&(b=PETRICHOR.resources.meshes[a],PETRICHOR.loadMesh(b));console.log("Loading programs...");for(a in PETRICHOR.resources.programs)PETRICHOR.resources.programs.hasOwnProperty(a)&&(b=PETRICHOR.resources.programs[a],PETRICHOR.loadProgram(b));console.log("Loading textures...");for(a in PETRICHOR.resources.textures)PETRICHOR.resources.textures.hasOwnProperty(a)&&(b=PETRICHOR.resources.textures[a],PETRICHOR.loadTexture2D(b));console.log("Loading music..."),PETRICHOR.loadMusic(PETRICHOR.resources.music)},PETRICHOR.isFinishedLoading=function(){return PETRICHOR.resources.loadCounter==countResources()},PETRICHOR.fps={frameTimes:[],currentFrame:0,frameStart:(new Date).getTime(),frameEnd:(new Date).getTime()},PETRICHOR.showFps=function(a){var b,c=0,d=0,e=0;for(PETRICHOR.fps.frameEnd=(new Date).getTime(),d=PETRICHOR.fps.frameEnd-PETRICHOR.fps.frameStart,PETRICHOR.fps.frameStart=PETRICHOR.fps.frameEnd,b=0;b<PETRICHOR.fps.frameTimes.length;b++)e+=PETRICHOR.fps.frameTimes[b];e>=1e3&&(c=(1e3*PETRICHOR.fps.frameTimes.length/e).toFixed(2),document.getElementById(a).innerHTML=c+" fps",PETRICHOR.fps.currentFrame=0,PETRICHOR.fps.frameTimes.length=0),PETRICHOR.fps.frameTimes[PETRICHOR.fps.currentFrame++]=d},PETRICHOR.extensions={},PETRICHOR.getExtension=function(a){var b,c=["","MOZ_","WEBKIT_"],d=null,e=PETRICHOR.gl;if(PETRICHOR.extensions.hasOwnProperty(a))return PETRICHOR.extensions[a];for(b=0;b<c.length&&(d=e.getExtension(c[b]+a),null===d);b++);return PETRICHOR.extensions[a]=d,d},function(a){var b={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(b.exports={},define(function(){return b.exports})):b.exports="undefined"!=typeof window?window:a:b.exports=exports,function(a){if(!b)var b=1e-6;if(!c)var c="undefined"!=typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={};e.setMatrixArrayType=function(a){c=a},"undefined"!=typeof a&&(a.glMatrix=e);var f=Math.PI/180;e.toRadian=function(a){return a*f};var g={};g.create=function(){var a=new c(2);return a[0]=0,a[1]=0,a},g.clone=function(a){var b=new c(2);return b[0]=a[0],b[1]=a[1],b},g.fromValues=function(a,b){var d=new c(2);return d[0]=a,d[1]=b,d},g.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},g.set=function(a,b,c){return a[0]=b,a[1]=c,a},g.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a},g.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},g.sub=g.subtract,g.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a},g.mul=g.multiply,g.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a},g.div=g.divide,g.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a},g.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a},g.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},g.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a},g.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},g.dist=g.distance,g.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},g.sqrDist=g.squaredDistance,g.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},g.len=g.length,g.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},g.sqrLen=g.squaredLength,g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a},g.normalize=function(a,b){var c=b[0],d=b[1],e=c*c+d*d;return e>0&&(e=1/Math.sqrt(e),a[0]=b[0]*e,a[1]=b[1]*e),a},g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},g.cross=function(a,b,c){var d=b[0]*c[1]-b[1]*c[0];return a[0]=a[1]=0,a[2]=d,a},g.lerp=function(a,b,c,d){var e=b[0],f=b[1];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a},g.random=function(a,b){b=b||1;var c=2*d()*Math.PI;return a[0]=Math.cos(c)*b,a[1]=Math.sin(c)*b,a},g.transformMat2=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e,a[1]=c[1]*d+c[3]*e,a},g.transformMat2d=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e+c[4],a[1]=c[1]*d+c[3]*e+c[5],a},g.transformMat3=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[3]*e+c[6],a[1]=c[1]*d+c[4]*e+c[7],a},g.transformMat4=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[4]*e+c[12],a[1]=c[1]*d+c[5]*e+c[13],a},g.forEach=function(){var a=g.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=2),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],f(a,a,g),b[h]=a[0],b[h+1]=a[1];return b}}(),g.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},"undefined"!=typeof a&&(a.vec2=g);var h={};h.create=function(){var a=new c(3);return a[0]=0,a[1]=0,a[2]=0,a},h.clone=function(a){var b=new c(3);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},h.fromValues=function(a,b,d){var e=new c(3);return e[0]=a,e[1]=b,e[2]=d,e},h.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},h.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},h.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},h.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},h.sub=h.subtract,h.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a},h.mul=h.multiply,h.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a},h.div=h.divide,h.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a},h.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a},h.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},h.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a},h.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)},h.dist=h.distance,h.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return c*c+d*d+e*e},h.sqrDist=h.squaredDistance,h.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},h.len=h.length,h.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},h.sqrLen=h.squaredLength,h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a},h.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*c+d*d+e*e;return f>0&&(f=1/Math.sqrt(f),a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f),a},h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},h.cross=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return a[0]=e*i-f*h,a[1]=f*g-d*i,a[2]=d*h-e*g,a},h.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a},h.random=function(a,b){b=b||1;var c=2*d()*Math.PI,e=2*d()-1,f=Math.sqrt(1-e*e)*b;return a[0]=Math.cos(c)*f,a[1]=Math.sin(c)*f,a[2]=e*b,a},h.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a[2]=c[2]*d+c[6]*e+c[10]*f+c[14],a},h.transformMat3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=d*c[0]+e*c[3]+f*c[6],a[1]=d*c[1]+e*c[4]+f*c[7],a[2]=d*c[2]+e*c[5]+f*c[8],a},h.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},h.rotateX=function(a,b,c,d){var e=[],f=[];return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e[2]=b[2]-c[2],f[0]=e[0],f[1]=e[1]*Math.cos(d)-e[2]*Math.sin(d),f[2]=e[1]*Math.sin(d)+e[2]*Math.cos(d),a[0]=f[0]+c[0],a[1]=f[1]+c[1],a[2]=f[2]+c[2],a},h.rotateY=function(a,b,c,d){var e=[],f=[];
return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e[2]=b[2]-c[2],f[0]=e[2]*Math.sin(d)+e[0]*Math.cos(d),f[1]=e[1],f[2]=e[2]*Math.cos(d)-e[0]*Math.sin(d),a[0]=f[0]+c[0],a[1]=f[1]+c[1],a[2]=f[2]+c[2],a},h.rotateZ=function(a,b,c,d){var e=[],f=[];return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e[2]=b[2]-c[2],f[0]=e[0]*Math.cos(d)-e[1]*Math.sin(d),f[1]=e[0]*Math.sin(d)+e[1]*Math.cos(d),f[2]=e[2],a[0]=f[0]+c[0],a[1]=f[1]+c[1],a[2]=f[2]+c[2],a},h.forEach=function(){var a=h.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=3),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2];return b}}(),h.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},"undefined"!=typeof a&&(a.vec3=h);var i={};i.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},i.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},i.fromValues=function(a,b,d,e){var f=new c(4);return f[0]=a,f[1]=b,f[2]=d,f[3]=e,f},i.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},i.set=function(a,b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,a[3]=e,a},i.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a[3]=b[3]+c[3],a},i.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a[3]=b[3]-c[3],a},i.sub=i.subtract,i.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a[3]=b[3]*c[3],a},i.mul=i.multiply,i.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a[3]=b[3]/c[3],a},i.div=i.divide,i.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a[3]=Math.min(b[3],c[3]),a},i.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a[3]=Math.max(b[3],c[3]),a},i.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a[3]=b[3]*c,a},i.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a[3]=b[3]+c[3]*d,a},i.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return Math.sqrt(c*c+d*d+e*e+f*f)},i.dist=i.distance,i.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return c*c+d*d+e*e+f*f},i.sqrDist=i.squaredDistance,i.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},i.len=i.length,i.squaredLength=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return b*b+c*c+d*d+e*e},i.sqrLen=i.squaredLength,i.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a},i.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f;return g>0&&(g=1/Math.sqrt(g),a[0]=b[0]*g,a[1]=b[1]*g,a[2]=b[2]*g,a[3]=b[3]*g),a},i.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},i.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[3];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a[3]=h+d*(c[3]-h),a},i.random=function(a,b){return b=b||1,a[0]=d(),a[1]=d(),a[2]=d(),a[3]=d(),i.normalize(a,a),i.scale(a,a,b),a},i.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*g,a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*g,a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*g,a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*g,a},i.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},i.forEach=function(){var a=i.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=4),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],a[3]=b[h+3],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2],b[h+3]=a[3];return b}}(),i.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.vec4=i);var j={};j.create=function(){var a=new c(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},j.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},j.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},j.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},j.transpose=function(a,b){if(a===b){var c=b[1];a[1]=b[2],a[2]=c}else a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},j.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*f-e*d;return g?(g=1/g,a[0]=f*g,a[1]=-d*g,a[2]=-e*g,a[3]=c*g,a):null},j.adjoint=function(a,b){var c=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=c,a},j.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},j.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*h+f*i,a[1]=e*h+g*i,a[2]=d*j+f*k,a[3]=e*j+g*k,a},j.mul=j.multiply,j.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+f*h,a[1]=e*i+g*h,a[2]=d*-h+f*i,a[3]=e*-h+g*i,a},j.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1];return a[0]=d*h,a[1]=e*h,a[2]=f*i,a[3]=g*i,a},j.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},j.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2))},j.LDU=function(a,b,c,d){return a[2]=d[2]/d[0],c[0]=d[0],c[1]=d[1],c[3]=d[3]-a[2]*c[1],[a,b,c]},"undefined"!=typeof a&&(a.mat2=j);var k={};k.create=function(){var a=new c(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},k.clone=function(a){var b=new c(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},k.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},k.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},k.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=c*f-d*e;return i?(i=1/i,a[0]=f*i,a[1]=-d*i,a[2]=-e*i,a[3]=c*i,a[4]=(e*h-f*g)*i,a[5]=(d*g-c*h)*i,a):null},k.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},k.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1],l=c[2],m=c[3],n=c[4],o=c[5];return a[0]=d*j+f*k,a[1]=e*j+g*k,a[2]=d*l+f*m,a[3]=e*l+g*m,a[4]=d*n+f*o+h,a[5]=e*n+g*o+i,a},k.mul=k.multiply,k.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=Math.sin(c),k=Math.cos(c);return a[0]=d*k+f*j,a[1]=e*k+g*j,a[2]=d*-j+f*k,a[3]=e*-j+g*k,a[4]=h,a[5]=i,a},k.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1];return a[0]=d*j,a[1]=e*j,a[2]=f*k,a[3]=g*k,a[4]=h,a[5]=i,a},k.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=d*j+f*k+h,a[5]=e*j+g*k+i,a},k.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},k.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+1)},"undefined"!=typeof a&&(a.mat2d=k);var l={};l.create=function(){var a=new c(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},l.fromMat4=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},l.clone=function(a){var b=new c(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},l.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},l.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},l.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},l.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(o=1/o,a[0]=l*o,a[1]=(-k*d+e*j)*o,a[2]=(h*d-e*g)*o,a[3]=m*o,a[4]=(k*c-e*i)*o,a[5]=(-h*c+e*f)*o,a[6]=n*o,a[7]=(-j*c+d*i)*o,a[8]=(g*c-d*f)*o,a):null},l.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return a[0]=g*k-h*j,a[1]=e*j-d*k,a[2]=d*h-e*g,a[3]=h*i-f*k,a[4]=c*k-e*i,a[5]=e*f-c*h,a[6]=f*j-g*i,a[7]=d*i-c*j,a[8]=c*g-d*f,a},l.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*(j*f-g*i)+c*(-j*e+g*h)+d*(i*e-f*h)},l.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=m*d+n*g+o*j,a[1]=m*e+n*h+o*k,a[2]=m*f+n*i+o*l,a[3]=p*d+q*g+r*j,a[4]=p*e+q*h+r*k,a[5]=p*f+q*i+r*l,a[6]=s*d+t*g+u*j,a[7]=s*e+t*h+u*k,a[8]=s*f+t*i+u*l,a},l.mul=l.multiply,l.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=m*d+n*g+j,a[7]=m*e+n*h+k,a[8]=m*f+n*i+l,a},l.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=Math.sin(c),n=Math.cos(c);return a[0]=n*d+m*g,a[1]=n*e+m*h,a[2]=n*f+m*i,a[3]=n*g-m*d,a[4]=n*h-m*e,a[5]=n*i-m*f,a[6]=j,a[7]=k,a[8]=l,a},l.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=e*b[3],a[4]=e*b[4],a[5]=e*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},l.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a},l.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=d*g,l=d*h,m=e*g,n=e*h,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-l-o,a[3]=k-r,a[6]=m+q,a[1]=k+r,a[4]=1-j-o,a[7]=n-p,a[2]=m-q,a[5]=n+p,a[8]=1-j-l,a},l.normalFromMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(i*A-g*D-j*z)*E,a[2]=(g*C-h*A+j*y)*E,a[3]=(e*C-d*D-f*B)*E,a[4]=(c*D-e*A+f*z)*E,a[5]=(d*A-c*C-f*y)*E,a[6]=(p*x-q*w+r*v)*E,a[7]=(q*u-o*x-r*t)*E,a[8]=(o*w-p*u+r*s)*E,a):null},l.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},l.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))},"undefined"!=typeof a&&(a.mat3=l);var m={};m.create=function(){var a=new c(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},m.clone=function(a){var b=new c(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},m.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},m.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},m.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=f,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},m.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(e*C-d*D-f*B)*E,a[2]=(p*x-q*w+r*v)*E,a[3]=(m*w-l*x-n*v)*E,a[4]=(i*A-g*D-j*z)*E,a[5]=(c*D-e*A+f*z)*E,a[6]=(q*u-o*x-r*t)*E,a[7]=(k*x-m*u+n*t)*E,a[8]=(g*C-h*A+j*y)*E,a[9]=(d*A-c*C-f*y)*E,a[10]=(o*w-p*u+r*s)*E,a[11]=(l*u-k*w-n*s)*E,a[12]=(h*z-g*B-i*y)*E,a[13]=(c*B-d*z+e*y)*E,a[14]=(p*t-o*v-q*s)*E,a[15]=(k*v-l*t+m*s)*E,a):null},m.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15];return a[0]=h*(m*r-n*q)-l*(i*r-j*q)+p*(i*n-j*m),a[1]=-(d*(m*r-n*q)-l*(e*r-f*q)+p*(e*n-f*m)),a[2]=d*(i*r-j*q)-h*(e*r-f*q)+p*(e*j-f*i),a[3]=-(d*(i*n-j*m)-h*(e*n-f*m)+l*(e*j-f*i)),a[4]=-(g*(m*r-n*q)-k*(i*r-j*q)+o*(i*n-j*m)),a[5]=c*(m*r-n*q)-k*(e*r-f*q)+o*(e*n-f*m),a[6]=-(c*(i*r-j*q)-g*(e*r-f*q)+o*(e*j-f*i)),a[7]=c*(i*n-j*m)-g*(e*n-f*m)+k*(e*j-f*i),a[8]=g*(l*r-n*p)-k*(h*r-j*p)+o*(h*n-j*l),a[9]=-(c*(l*r-n*p)-k*(d*r-f*p)+o*(d*n-f*l)),a[10]=c*(h*r-j*p)-g*(d*r-f*p)+o*(d*j-f*h),a[11]=-(c*(h*n-j*l)-g*(d*n-f*l)+k*(d*j-f*h)),a[12]=-(g*(l*q-m*p)-k*(h*q-i*p)+o*(h*m-i*l)),a[13]=c*(l*q-m*p)-k*(d*q-e*p)+o*(d*m-e*l),a[14]=-(c*(h*q-i*p)-g*(d*q-e*p)+o*(d*i-e*h)),a[15]=c*(h*m-i*l)-g*(d*m-e*l)+k*(d*i-e*h),a},m.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p;return r*C-s*B+t*A+u*z-v*y+w*x},m.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3];return a[0]=t*d+u*h+v*l+w*p,a[1]=t*e+u*i+v*m+w*q,a[2]=t*f+u*j+v*n+w*r,a[3]=t*g+u*k+v*o+w*s,t=c[4],u=c[5],v=c[6],w=c[7],a[4]=t*d+u*h+v*l+w*p,a[5]=t*e+u*i+v*m+w*q,a[6]=t*f+u*j+v*n+w*r,a[7]=t*g+u*k+v*o+w*s,t=c[8],u=c[9],v=c[10],w=c[11],a[8]=t*d+u*h+v*l+w*p,a[9]=t*e+u*i+v*m+w*q,a[10]=t*f+u*j+v*n+w*r,a[11]=t*g+u*k+v*o+w*s,t=c[12],u=c[13],v=c[14],w=c[15],a[12]=t*d+u*h+v*l+w*p,a[13]=t*e+u*i+v*m+w*q,a[14]=t*f+u*j+v*n+w*r,a[15]=t*g+u*k+v*o+w*s,a},m.mul=m.multiply,m.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=c[0],q=c[1],r=c[2];return b===a?(a[12]=b[0]*p+b[4]*q+b[8]*r+b[12],a[13]=b[1]*p+b[5]*q+b[9]*r+b[13],a[14]=b[2]*p+b[6]*q+b[10]*r+b[14],a[15]=b[3]*p+b[7]*q+b[11]*r+b[15]):(d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=j,a[7]=k,a[8]=l,a[9]=m,a[10]=n,a[11]=o,a[12]=d*p+h*q+l*r+b[12],a[13]=e*p+i*q+m*r+b[13],a[14]=f*p+j*q+n*r+b[14],a[15]=g*p+k*q+o*r+b[15]),a},m.scale=function(a,b,c){var d=c[0],e=c[1],f=c[2];return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a[4]=b[4]*e,a[5]=b[5]*e,a[6]=b[6]*e,a[7]=b[7]*e,a[8]=b[8]*f,a[9]=b[9]*f,a[10]=b[10]*f,a[11]=b[11]*f,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},m.rotate=function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=e[0],E=e[1],F=e[2],G=Math.sqrt(D*D+E*E+F*F);return Math.abs(G)<b?null:(G=1/G,D*=G,E*=G,F*=G,f=Math.sin(d),g=Math.cos(d),h=1-g,i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7],q=c[8],r=c[9],s=c[10],t=c[11],u=D*D*h+g,v=E*D*h+F*f,w=F*D*h-E*f,x=D*E*h-F*f,y=E*E*h+g,z=F*E*h+D*f,A=D*F*h+E*f,B=E*F*h-D*f,C=F*F*h+g,a[0]=i*u+m*v+q*w,a[1]=j*u+n*v+r*w,a[2]=k*u+o*v+s*w,a[3]=l*u+p*v+t*w,a[4]=i*x+m*y+q*z,a[5]=j*x+n*y+r*z,a[6]=k*x+o*y+s*z,a[7]=l*x+p*y+t*z,a[8]=i*A+m*B+q*C,a[9]=j*A+n*B+r*C,a[10]=k*A+o*B+s*C,a[11]=l*A+p*B+t*C,c!==a&&(a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]),a)},m.rotateX=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=f*e+j*d,a[5]=g*e+k*d,a[6]=h*e+l*d,a[7]=i*e+m*d,a[8]=j*e-f*d,a[9]=k*e-g*d,a[10]=l*e-h*d,a[11]=m*e-i*d,a},m.rotateY=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e-j*d,a[1]=g*e-k*d,a[2]=h*e-l*d,a[3]=i*e-m*d,a[8]=f*d+j*e,a[9]=g*d+k*e,a[10]=h*d+l*e,a[11]=i*d+m*e,a},m.rotateZ=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],m=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e+j*d,a[1]=g*e+k*d,a[2]=h*e+l*d,a[3]=i*e+m*d,a[4]=j*e-f*d,a[5]=k*e-g*d,a[6]=l*e-h*d,a[7]=m*e-i*d,a},m.fromRotationTranslation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return a[0]=1-(n+p),a[1]=l+s,a[2]=m-r,a[3]=0,a[4]=l-s,a[5]=1-(k+p),a[6]=o+q,a[7]=0,a[8]=m+r,a[9]=o-q,a[10]=1-(k+n),a[11]=0,a[12]=c[0],a[13]=c[1],a[14]=c[2],a[15]=1,a},m.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=d*g,l=d*h,m=e*g,n=e*h,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-l-o,a[1]=k+r,a[2]=m-q,a[3]=0,a[4]=k-r,a[5]=1-j-o,a[6]=n+p,a[7]=0,a[8]=m+q,a[9]=n-p,a[10]=1-j-l,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},m.frustum=function(a,b,c,d,e,f,g){var h=1/(c-b),i=1/(e-d),j=1/(f-g);return a[0]=2*f*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f*i,a[6]=0,a[7]=0,a[8]=(c+b)*h,a[9]=(e+d)*i,a[10]=(g+f)*j,a[11]=-1,a[12]=0,a[13]=0,a[14]=g*f*2*j,a[15]=0,a},m.perspective=function(a,b,c,d,e){var f=1/Math.tan(b/2),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(e+d)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*e*d*g,a[15]=0,a},m.ortho=function(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a},m.lookAt=function(a,c,d,e){var f,g,h,i,j,k,l,n,o,p,q=c[0],r=c[1],s=c[2],t=e[0],u=e[1],v=e[2],w=d[0],x=d[1],y=d[2];return Math.abs(q-w)<b&&Math.abs(r-x)<b&&Math.abs(s-y)<b?m.identity(a):(l=q-w,n=r-x,o=s-y,p=1/Math.sqrt(l*l+n*n+o*o),l*=p,n*=p,o*=p,f=u*o-v*n,g=v*l-t*o,h=t*n-u*l,p=Math.sqrt(f*f+g*g+h*h),p?(p=1/p,f*=p,g*=p,h*=p):(f=0,g=0,h=0),i=n*h-o*g,j=o*f-l*h,k=l*g-n*f,p=Math.sqrt(i*i+j*j+k*k),p?(p=1/p,i*=p,j*=p,k*=p):(i=0,j=0,k=0),a[0]=f,a[1]=i,a[2]=l,a[3]=0,a[4]=g,a[5]=j,a[6]=n,a[7]=0,a[8]=h,a[9]=k,a[10]=o,a[11]=0,a[12]=-(f*q+g*r+h*s),a[13]=-(i*q+j*r+k*s),a[14]=-(l*q+n*r+o*s),a[15]=1,a)},m.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},m.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))},"undefined"!=typeof a&&(a.mat4=m);var n={};n.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},n.rotationTo=function(){var a=h.create(),b=h.fromValues(1,0,0),c=h.fromValues(0,1,0);return function(d,e,f){var g=h.dot(e,f);return-.999999>g?(h.cross(a,b,e),h.length(a)<1e-6&&h.cross(a,c,e),h.normalize(a,a),n.setAxisAngle(d,a,Math.PI),d):g>.999999?(d[0]=0,d[1]=0,d[2]=0,d[3]=1,d):(h.cross(a,e,f),d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=1+g,n.normalize(d,d))}}(),n.setAxes=function(){var a=l.create();return function(b,c,d,e){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=-c[0],a[5]=-c[1],a[8]=-c[2],n.normalize(b,n.fromMat3(b,a))}}(),n.clone=i.clone,n.fromValues=i.fromValues,n.copy=i.copy,n.set=i.set,n.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},n.setAxisAngle=function(a,b,c){c=.5*c;var d=Math.sin(c);return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=Math.cos(c),a},n.add=i.add,n.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},n.mul=n.multiply,n.scale=i.scale,n.rotateX=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+g*h,a[1]=e*i+f*h,a[2]=f*i-e*h,a[3]=g*i-d*h,a},n.rotateY=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i-f*h,a[1]=e*i+g*h,a[2]=f*i+d*h,a[3]=g*i-e*h,a},n.rotateZ=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=e*i-d*h,a[2]=f*i+g*h,a[3]=g*i-f*h,a},n.calculateW=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c,a[1]=d,a[2]=e,a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a},n.dot=i.dot,n.lerp=i.lerp,n.slerp=function(a,b,c,d){var e,f,g,h,i,j=b[0],k=b[1],l=b[2],m=b[3],n=c[0],o=c[1],p=c[2],q=c[3];return f=j*n+k*o+l*p+m*q,0>f&&(f=-f,n=-n,o=-o,p=-p,q=-q),1-f>1e-6?(e=Math.acos(f),g=Math.sin(e),h=Math.sin((1-d)*e)/g,i=Math.sin(d*e)/g):(h=1-d,i=d),a[0]=h*j+i*n,a[1]=h*k+i*o,a[2]=h*l+i*p,a[3]=h*m+i*q,a},n.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return a[0]=-c*h,a[1]=-d*h,a[2]=-e*h,a[3]=f*h,a},n.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a},n.length=i.length,n.len=n.length,n.squaredLength=i.squaredLength,n.sqrLen=n.squaredLength,n.normalize=i.normalize,n.fromMat3=function(a,b){var c,d=b[0]+b[4]+b[8];if(d>0)c=Math.sqrt(d+1),a[3]=.5*c,c=.5/c,a[0]=(b[7]-b[5])*c,a[1]=(b[2]-b[6])*c,a[2]=(b[3]-b[1])*c;else{var e=0;b[4]>b[0]&&(e=1),b[8]>b[3*e+e]&&(e=2);var f=(e+1)%3,g=(e+2)%3;c=Math.sqrt(b[3*e+e]-b[3*f+f]-b[3*g+g]+1),a[e]=.5*c,c=.5/c,a[3]=(b[3*g+f]-b[3*f+g])*c,a[f]=(b[3*f+e]+b[3*e+f])*c,a[g]=(b[3*g+e]+b[3*e+g])*c}return a},n.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.quat=n)}(b.exports)}(this);var JSRocket={};JSRocket.SyncData=function(){function a(a){return e[a]}function b(a){for(var b=0;b<e.length;b++)if(e[b].name===a)return b;return-1}function c(){return e.length}function d(a){var b=new JSRocket.Track;b.name=a,e.push(b)}var e=[];return{getTrack:a,getIndexForName:b,getTrackLength:c,createIndex:d}},JSRocket.Track=function(){function a(a){var c,d=Math.floor(a),e=b(d),k=e.low,l=e.high;if(isNaN(k))return 0/0;if(isNaN(l)||j[k].interpolation===f)return j[k].value;switch(j[k].interpolation){case g:return c=(a-k)/(l-k),j[k].value+(j[l].value-j[k].value)*c;case h:return c=(a-k)/(l-k),c=c*c*(3-2*c),j[l].value*c+j[k].value*(1-c);case i:return c=Math.pow((a-k)/(l-k),2),j[k].value+(j[l].value-j[k].value)*c}return 0/0}function b(a){for(var b=0/0,c=0/0,d=0;d<k.length;d++)if(k[d]<=a)b=k[d];else if(k[d]>=a){c=k[d];break}return{low:b,high:c}}function c(a,b,c,f){e(a),k.push(a),j[a]={value:b,interpolation:c},f!==!0&&d()}function d(){k=k.sort(function(a,b){return a-b})}function e(a){k.indexOf(a)>-1&&(k.splice(k.indexOf(a),1),delete j[a])}var f=0,g=1,h=2,i=3,j=[],k=[];return{getValue:a,sortIndex:d,add:c,remove:e}},JSRocket.SyncDevicePlayer=function(a){function b(a){return h=new XMLHttpRequest,null===h?void j.error():(h.open("GET",a,!0),h.onreadystatechange=c,h.send(),void 0)}function c(){4===h.readyState&&(h.status<300?d(h.responseText):j.error())}function d(a){var b,c,d,f=0,g=0,h=(new DOMParser).parseFromString(a,"text/xml"),i=h.getElementsByTagName("tracks"),k=i[0].getElementsByTagName("track");for(c=k.length;c>f;f++){var l=e(k[f].getAttribute("name")),m=k[f].getElementsByTagName("key");for(g=0,d=m.length;d>g;g++)b=m[g],l.add(parseInt(b.getAttribute("row"),10),parseFloat(b.getAttribute("value")),parseInt(b.getAttribute("interpolation"),10),!0);l.sortIndex()}j.ready()}function e(a){var b=i.getIndexForName(a);return b>-1?i.getTrack(b):(i.createIndex(a),i.getTrack(i.getTrackLength()-1))}function f(a,b){j[a]=b}function g(){}var h,i=new JSRocket.SyncData,j={ready:function(){},error:function(){}};if(""===a.rocketXML||void 0===a.rocketXML||void 0===a.rocketXML)throw"[jsRocket] rocketXML is not set, try _syncDevice.setConfig({'rocketXML':'url/To/RocketXML.rocket'})";return b(a.rocketXML),{load:b,getTrack:e,update:g,on:f}},JSRocket.SyncDeviceClient=function(a){function b(){q.binaryType="arraybuffer",q.send("hello, synctracker!")}function c(a){var b,c,d,e,f=new Uint8Array(a.data),g=f[0];104===g?s.ready():o===g?1===f[1]?s.pause():s.play():n===g?(c=h(f.subarray(1,5)),s.update(c)):k===g?(b=h(f.subarray(1,5)),c=h(f.subarray(5,9)),d=i(f.subarray(9,13)),e=h(f.subarray(13,14)),r.getTrack(b).add(c,d,e),s.update()):l===g?(b=h(f.subarray(1,5)),c=h(f.subarray(5,9)),r.getTrack(b).remove(c),s.update()):p===g&&s.save()}function d(a){console.warn(">> connection closed",a)}function e(a){console.error(">> connection error'd",a)}function f(a){var b=r.getIndexForName(a);return b>-1?r.getTrack(b):(q.send(new Uint8Array([m,0,0,0,a.length]).buffer),q.send(a),r.createIndex(a),r.getTrack(r.getTrackLength()-1))}function g(a){var b=[a>>24&255,a>>16&255,a>>8&255,255&a];q.send(new Uint8Array([n,b[0],b[1],b[2],b[3]]).buffer)}function h(a){for(var b=0,c=new DataView(new ArrayBuffer(a.length));b<a.length;b++)c.setUint8(b,a[b]);return 1===c.byteLength?c.getInt8(0):c.getInt32(0)}function i(a){var b=new DataView(new ArrayBuffer(4));return b.setUint8(0,a[0]),b.setUint8(1,a[1]),b.setUint8(2,a[2]),b.setUint8(3,a[3]),b.getFloat32(0)}function j(a,b){s[a]=b}var k=0,l=1,m=2,n=3,o=4,p=5,q=new WebSocket(a.socketURL),r=new JSRocket.SyncData,s={ready:function(){},update:function(){},play:function(){},pause:function(){},save:function(){}};return q.onopen=b,q.onmessage=c,q.onclose=d,q.onerror=e,{getTrack:f,update:g,on:j}},JSRocket.SyncDevice=function(){function a(a){k="demo"===a?new JSRocket.SyncDevicePlayer(n):new JSRocket.SyncDeviceClient(n),k.on("ready",d),k.on("update",e),k.on("play",f),k.on("pause",g)}function b(){return n}function c(a){for(var b in a)a.hasOwnProperty(b)&&(n[b]=a[b]);return n}function d(){m=!0,o.ready()}function e(a){o.update(a)}function f(){o.play()}function g(){o.pause()}function h(a){return m?k.getTrack(a):null}function i(a){Math.floor(a)!==l&&(l=Math.floor(a),k.update(l))}function j(a,b){o[a]=b}var k,l,m=!1,n={socketURL:"ws://localhost:1338",rocketXML:""},o={ready:function(){},update:function(){},play:function(){},pause:function(){}};return{init:a,setConfig:c,getConfig:b,getTrack:h,update:i,on:j}};