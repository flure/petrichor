/*
Copyright Â© 2014 Florent 'flure' CURE <florent.cure@gmail.com>
This work is free. You can redistribute it and/or modify it under the
terms of the Do What The Fuck You Want To Public License, Version 2,
as published by Sam Hocevar. See http://www.wtfpl.net/ for more details.
*/
"use strict";function countResources(){var a,b=0;for(a in PETRICHOR.resources.meshes)PETRICHOR.resources.meshes.hasOwnProperty(a)&&b++;for(a in PETRICHOR.resources.programs)PETRICHOR.resources.programs.hasOwnProperty(a)&&b++;for(a in PETRICHOR.resources.textures)PETRICHOR.resources.textures.hasOwnProperty(a)&&b++;return PETRICHOR.resources.music&&b++,b}var PETRICHOR=PETRICHOR||{};PETRICHOR.Camera=function(){return this.matrixUniforms={},this.fovy=45,this.near=.1,this.far=2,this.ratio=4/3,this.position=[0,0,3],this.center=[0,0,0],this.up=[0,1,0],this.projectionMatrix=mat4.create(),this.viewMatrix=mat4.create(),this.setPerspective=function(){return mat4.perspective(this.projectionMatrix,this.fovy,this.ratio,this.near,this.far),this},this.setOrthographic=function(a,b,c,d){return mat4.ortho(this.projectionMatrix,a,b,c,d,this.near,this.far),this},this.lookAt=function(){return mat4.lookAt(this.viewMatrix,this.position,this.center,this.up),this},this.setUniform=function(a,b){return this.matrixUniforms[a]=b,this},this.upload=function(a,b){var c=b.getTransformationMatrix(),d=mat4.create(),e=mat3.create();mat4.multiply(d,this.projectionMatrix,this.viewMatrix),mat4.multiply(d,d,c),mat3.normalFromMat4(e,c),a.setUniformMatrix3fv(this.matrixUniforms.normalMatrix,e),a.setUniformMatrix4fv(this.matrixUniforms.modelMatrix,c),a.setUniformMatrix4fv(this.matrixUniforms.projectionMatrix,this.projectionMatrix),a.setUniformMatrix4fv(this.matrixUniforms.viewMatrix,this.viewMatrix),a.setUniformMatrix4fv(this.matrixUniforms.mvpMatrix,d),a.setUniform1f(this.matrixUniforms.near,this.near),a.setUniform1f(this.matrixUniforms.far,this.far)},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.effects=[],PETRICHOR.addEffect=function(a){PETRICHOR.effects.push(a)},PETRICHOR.time=0,PETRICHOR.initEffects=function(){var a=0,b=null;for(a=0;a<PETRICHOR.effects.length;a++)b=PETRICHOR.effects[a],b.init();PETRICHOR.time=(new Date).getTime()},PETRICHOR.playEffects=function(a){var b,c,d,e=0,f=a||(new Date).getTime()-PETRICHOR.time,g=null;for(e=0;e<PETRICHOR.effects.length;e++)g=PETRICHOR.effects[e],b=g.startTime||0,c=g.endTime||99999,d=g.loop||!1,f>=b&&(d||c>=f)&&g.update(f)},PETRICHOR.start=function(){PETRICHOR.initEffects(),function a(){PETRICHOR.play(),window.requestAnimFrame(a,document)}()},PETRICHOR.play=function(a){var b=document.getElementById("chkFps"),c=document.getElementById("fps");void 0!=b&&void 0!=c&&(document.getElementById("chkFps").checked?PETRICHOR.showFps("fps"):c.innerHTML=""),PETRICHOR.playEffects(a)};var PETRICHOR=PETRICHOR||{};PETRICHOR.Fbo=function(a,b){return this.frameBuffer=null,this.colorBuffer=null,this.depthBuffer=null,this.width=a,this.height=b,this.build=function(a){var b=PETRICHOR.gl;if(this.frameBuffer=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.getError()!=b.NO_ERROR&&alert("Error in gl.bindFramebuffer"),this.colorBuffer=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.colorBuffer),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGB,this.width,this.height,0,b.RGB,b.UNSIGNED_BYTE,null),b.getError()!=b.NO_ERROR&&alert("Error in creating the fbo color buffer"),a){var c=PETRICHOR.getExtension("WEBGL_depth_texture");if(null==c)return void alert("WEBGL_depth_texture extension required.\nPlease switch to a modern browser.");this.depthBuffer=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.depthBuffer),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.DEPTH_COMPONENT,this.width,this.height,0,b.DEPTH_COMPONENT,b.UNSIGNED_SHORT,null),b.getError()!=b.NO_ERROR&&alert("Error in creating the fbo depth buffer")}else this.depthBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.depthBuffer),b.getError()!=b.NO_ERROR&&alert("Error in gl.bindRenderbuffer"),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);b.getError()!=b.NO_ERROR&&alert("Error in gl.renderbufferStorage"),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.colorBuffer,0),b.getError()!=b.NO_ERROR&&alert("Error attaching color buffer"),a?b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.TEXTURE_2D,this.depthBuffer,0):b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depthBuffer),b.getError()!=b.NO_ERROR&&alert("Error attaching depth buffer"),b.checkFramebufferStatus(b.FRAMEBUFFER)!=b.FRAMEBUFFER_COMPLETE&&alert("Error in FBO creation"),b.bindTexture(b.TEXTURE_2D,null),b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null)},this.begin=function(){var a=PETRICHOR.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.getError()!=a.NO_ERROR&&alert("Error in Fbo.begin")},this.end=function(){var a=PETRICHOR.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),a.getError()!=a.NO_ERROR&&alert("Error in Fbo.end")},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.Light=function(){return this.color=vec3.fromValues(1,1,1),this.position=vec3.fromValues(0,0,0),this.radius=2,this.power=1,this.uniforms={color:"",position:"",radius:"",power:""},this.setUniforms=function(a){return a.hasOwnProperty("color")&&a.color&&(this.uniforms.color=a.color),a.hasOwnProperty("position")&&a.position&&(this.uniforms.position=a.position),a.hasOwnProperty("radius")&&a.radius&&(this.uniforms.radius=a.radius),a.hasOwnProperty("power")&&a.power&&(this.uniforms.power=a.power),this},this.uploadParams=function(a){this.uniforms.color&&a.setUniform3fv(this.uniforms.color,this.color),this.uniforms.position&&a.setUniform3fv(this.uniforms.position,this.position),this.uniforms.radius&&a.setUniform1f(this.uniforms.radius,this.radius),this.uniforms.power&&a.setUniform1f(this.uniforms.power,this.power)},this};var PETRICHOR=PETRICHOR||{};PETRICHOR.Mesh=function(a,b){return this.vertices=null,this.normals=null,this.textureCoords=null,this.indices=null,this.transform=new PETRICHOR.Transform,this.textures=[],this.isDynamic=a||!1,this.vertexBuffer=null,this.normalBuffer=null,this.textureCoordsBuffer=null,this.indexBuffer=null,this.attributeNames={},b&&this.set(b),this.set=function(a){return a.hasOwnProperty("vertices")&&(this.vertices=new Float32Array(a.vertices)),a.hasOwnProperty("normals")&&(this.normals=new Float32Array(a.normals)),a.hasOwnProperty("uv")&&(this.textureCoords=new Float32Array(a.uv)),a.hasOwnProperty("indices")&&(this.indices=new Uint16Array(a.indices)),this},this.build=function(){var a=PETRICHOR.gl;return this.vertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.vertices),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.itemCount=this.vertices.length/3,this.normals&&(this.normalBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.normals),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.normalBuffer.itemSize=3,this.normalBuffer.itemCount=this.normals.length/3),this.textureCoords&&(this.textureCoordsBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.textureCoordsBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.textureCoords),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.textureCoordsBuffer.itemSize=2,this.textureCoordsBuffer.itemCount=this.textureCoords.length/2),this.indices&&(this.indexBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),this.isDynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.indexBuffer.itemSize=1,this.indexBuffer.itemCount=this.indices.length),this},this.render=function(a,b){var c,d,e=PETRICHOR.gl,f=-1,g=-1,h=-1;a.enable(),b&&b.upload(a,this.transform);try{for(c=0;c<this.textures.length;c++)d=this.textures[c],d.texture.enable(d.unit),a.setUniform1i(d.sampler,d.unit)}catch(i){console.log(i)}return this.attributeNames.hasOwnProperty("vertex")&&(f=a.attributes.get(this.attributeNames.vertex)),this.attributeNames.hasOwnProperty("normal")&&(g=a.attributes.get(this.attributeNames.normal)),this.attributeNames.hasOwnProperty("uv")&&(h=a.attributes.get(this.attributeNames.uv)),e.enableVertexAttribArray(f),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(f,this.vertexBuffer.itemSize,e.FLOAT,!1,0,0),this.attributeNames.hasOwnProperty("normal")&&(e.enableVertexAttribArray(g),e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer),e.vertexAttribPointer(g,this.normalBuffer.itemSize,e.FLOAT,!1,0,0)),this.attributeNames.hasOwnProperty("uv")&&(e.enableVertexAttribArray(h),e.bindBuffer(e.ARRAY_BUFFER,this.textureCoordsBuffer),e.vertexAttribPointer(h,this.textureCoordsBuffer.itemSize,e.FLOAT,!1,0,0)),this.indices?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.drawElements(e.TRIANGLES,this.indexBuffer.itemCount,e.UNSIGNED_SHORT,0)):e.drawArrays(e.TRIANGLES,0,this.vertices.length/3),this},this.setAttributeName=function(a,b){return this.attributeNames[a]=b,this},this.setTexture=function(a,b,c){var d={unit:a,texture:b,sampler:c};return this.textures.push(d),this},this},PETRICHOR.Transform=function(){return this.translation=vec3.create(),this.rotation=vec3.create(),this.scale=vec3.fromValues(1,1,1),this.transformMatrix=mat4.create(),this.setTranslation=function(a,b,c){return this.translation[0]=a,this.translation[1]=b,this.translation[2]=c,this},this.setRotation=function(a,b,c){return this.rotation[0]=a,this.rotation[1]=b,this.rotation[2]=c,this},this.setScale=function(a,b,c){return this.scale[0]=a,this.scale[1]=b,this.scale[2]=c,this},this.getTransformationMatrix=function(){var a=(mat4.create(),mat4.create(),mat4.create()),b=(quat.create(),quat.create(),quat.create(),quat.create(),quat.create());return quat.identity(b),quat.rotateX(b,b,this.rotation[0]),quat.rotateY(b,b,this.rotation[1]),quat.rotateZ(b,b,this.rotation[2]),quat.normalize(b,b),mat4.fromRotationTranslation(this.transformMatrix,b,this.translation),mat4.scale(a,a,this.scale),mat4.multiply(this.transformMatrix,this.transformMatrix,a),this.transformMatrix},this},PETRICHOR.loadMesh=function(a){function b(a,b){var c=JSON.parse(b.responseText);a.mesh=new PETRICHOR.Mesh,a.mesh.set(c),a.mesh.isDynamic=c.isDynamic,a.mesh.build(),PETRICHOR.resources.loadCounter++}var c=new XMLHttpRequest;c.open("GET",a.path),c.overrideMimeType("text/plain"),c.onreadystatechange=function(a,c){return function(){4==c.readyState&&b(a,c)}}(a,c),c.send()};var PETRICHOR=PETRICHOR||{};PETRICHOR.music=null,PETRICHOR.loadMusic=function(a){var b=!1,c=!1;if(console.log("Loading music..."),a){if(!a.ogg&&!a.mp3)return void console.log("No path for music.");a.audio=new Audio,c=!(!a.audio.canPlayType||!a.audio.canPlayType("audio/mpeg;").replace(/no/,"")),b=!(!a.audio.canPlayType||!a.audio.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")),a.hasOwnProperty("mp3")&&c?(a.audio.src=a.mp3,console.log("Music loaded: MP3 format.")):a.hasOwnProperty("ogg")&&b?(a.audio.src=a.ogg,console.log("Music loaded: OGG format.")):console.log("Music not loaded: unsupported format."),PETRICHOR.music=PETRICHOR.resources.music.audio,PETRICHOR.resources.loadCounter++}};var PETRICHOR=PETRICHOR||{};PETRICHOR.Program=function(){function a(a,b){var c=PETRICHOR.gl,d=0,e="";if(b){if("vertex"===a)d=c.createShader(c.VERTEX_SHADER);else{if("fragment"!==a)return 0;d=c.createShader(c.FRAGMENT_SHADER)}return c.shaderSource(d,b),c.compileShader(d),c.getShaderParameter(d,c.COMPILE_STATUS)?d:(e=c.getShaderInfoLog(d),e&&(window.alert("Error in the "+a+" shader.\nCheck console to see details."),console.log(e)),null)}}var b=PETRICHOR.gl;return this.id=null,this.vertexId=null,this.fragmentId=null,this.vertexSrc="",this.fragmentSrc="",this.uniforms=new PETRICHOR.Uniforms(this),this.attributes=new PETRICHOR.Attributes(this),this.setSource=function(a,b){this.vertexSrc=a,this.fragmentSrc=b},this.build=function(){var b=PETRICHOR.gl;return this.id=b.createProgram(),this.vertexId=a("vertex",this.vertexSrc),this.fragmentId=a("fragment",this.fragmentSrc),b.attachShader(this.id,this.vertexId),b.attachShader(this.id,this.fragmentId),b.linkProgram(this.id),b.getProgramParameter(this.id,b.LINK_STATUS)||window.alert("Could not initialise shader"),this},this.enable=function(){var a=PETRICHOR.gl;return this.id||this.build(),a.useProgram(this.id),this},this.disable=function(){var a=PETRICHOR.gl;return a.useProgram(null),this},this.setU={mat3:function(){return b.uniformMatrix3fv}(),mat4:function(){return b.uniformMatrix4fv}(),"int":function(){return b.uniform1i}()},this.setUniformMatrix3fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniformMatrix3fv(d,!1,b):this},this.setUniformMatrix4fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniformMatrix4fv(d,!1,b):this},this.setUniform1i=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform1i(d,b):this},this.setUniform2fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform2fv(d,b):this},this.setUniform3fv=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform3fv(d,b):this},this.setUniform1f=function(a,b){var c=PETRICHOR.gl,d=this.uniforms.get(a);return d&&-1!==d?void c.uniform1f(d,b):this},this},PETRICHOR.Uniforms=function(a){return this.program=a,this.bindings={},this.get=function(b){var c=PETRICHOR.gl;return this.bindings[b]&&this.bindings.hasOwnProperty(b)&&-1!==this.bindings[b]||(a.enable(),this.bindings[b]=c.getUniformLocation(this.program.id,b)),this.bindings[b]},this},PETRICHOR.Attributes=function(a){return this.program=a,this.bindings={},this.get=function(b){var c=PETRICHOR.gl;return this.bindings[b]&&this.bindings.hasOwnProperty(b)&&-1!==this.bindings[b]||(a.enable(),this.bindings[b]=c.getAttribLocation(this.program.id,b)),this.bindings[b]},this},PETRICHOR.loadProgram=function(a){function b(a){return console.log("finalizeProgramLoad"),a.program.fragmentSrc&&a.program.vertexSrc?(a.program.build(),void PETRICHOR.resources.loadCounter++):void setTimeout(function(){b(a)},50)}function c(a,b,c){switch(c){case"fragment":a.program.fragmentSrc=b.responseText;break;case"vertex":a.program.vertexSrc=b.responseText}}var d=a.vertexPath,e=a.fragmentPath,f=new XMLHttpRequest,g=new XMLHttpRequest;a.program=new PETRICHOR.Program,f.open("GET",d),f.overrideMimeType("text/plain"),f.onreadystatechange=function(a,b){return function(){4==b.readyState&&c(a,b,"vertex")}}(a,f),g.open("GET",e),g.overrideMimeType("text/plain"),g.onreadystatechange=function(a,b){return function(){4==b.readyState&&c(a,b,"fragment")}}(a,g),f.send(),g.send(),b(a)};var PETRICHOR=PETRICHOR||{};PETRICHOR.SyncManager=function(a,b,c,d,e){return this.BPM=b,this.ROWS_PER_BEAT=c,this.ROW_RATE=this.BPM/60*this.ROWS_PER_BEAT,this.rocketFile=a,this.editMode=d,this.port=e,this.device=new JSRocket.SyncDevice,this.tracks={},this.trackNames=[],this.row=0,this.onReady=function(){PETRICHOR.initEffects(),this.setTracks(this.trackNames),this.editMode?(PETRICHOR.music.pause(),PETRICHOR.music.currentTime=this.row/ROW_RATE):(this.render(),PETRICHOR.music.play())},this.onUpdate=function(a){isNaN(a)||(this.row=a)},this.onPlay=function(){PETRICHOR.music.currentTime=this.row/this.ROW_RATE,PETRICHOR.music.play(),this.render(),console.log("play at row "+this.row+" ["+PETRICHOR.music.currentTime+"ms]")},this.onPause=function(){this.row=PETRICHOR.music.currentTime*this.ROW_RATE,window.cancelAnimationFrame(this.render,document),PETRICHOR.music.pause(),console.log("pause at row "+this.row+" ["+PETRICHOR.music.currentTime+"ms]")},this.init=function(){this.editMode?(this.port&&this.device.setConfig({socketUrl:"ws://localhost:"+this.port}),this.device.init()):(this.device.setConfig({rocketXML:this.rocketFile}),this.device.init("demo"));this.device.on("ready",function(){this.onReady()}.bind(this)),this.device.on("update",function(a){this.onUpdate(a)}.bind(this)),this.device.on("play",function(){this.onPlay()}.bind(this)),this.device.on("pause",function(){this.onPause()}.bind(this))},this.getTrack=function(a){return this.tracks[a].getValue(this.row)},this.setTracks=function(a){var b;for(b=0;b<a.length;b++)this.tracks[a[b]]=this.device.getTrack(a[b])},this.render=function(){PETRICHOR.music.paused===!1&&(this.row=PETRICHOR.music.currentTime*this.ROW_RATE,this.device.update(this.row)),PETRICHOR.play(PETRICHOR.music.currentTime),this.editMode&&PETRICHOR.music.paused!==!1?window.cancelAnimationFrame(function(){this.render()}.bind(this),document):window.requestAnimationFrame(function(){this.render()}.bind(this),document)},this},PETRICHOR.sync=null,PETRICHOR.initSync=function(a,b,c,d,e,f){return PETRICHOR.sync=new PETRICHOR.SyncManager(a,b,c,d,e),PETRICHOR.sync.trackNames=f,PETRICHOR.sync.init(),PETRICHOR.sync};var PETRICHOR=PETRICHOR||{};PETRICHOR.Texture2D=function(){var a=PETRICHOR.gl;return this.image=null,this.filter={min:a.LINEAR_MIPMAP_LINEAR,mag:a.LINEAR},this.wrap={s:a.CLAMP_TO_EDGE,t:a.CLAMP_TO_EDGE},this.id=null,this.build=function(){var a=PETRICHOR.gl;return this.id=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.id),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.image),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.filter.min),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,this.filter.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,this.wrap.s),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,this.wrap.t),(this.filter.min==a.LINEAR_MIPMAP_NEAREST||this.filter.min==a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(a.TEXTURE_2D),this},this.enable=function(b){return a.activeTexture(a.TEXTURE0+b),a.bindTexture(a.TEXTURE_2D,this.id),this},this.disable=function(){return a.bindTexture(a.TEXTURE_2D,null),this},this},PETRICHOR.loadTexture2D=function(a){function b(a){try{a.build(),PETRICHOR.resources.loadCounter++}catch(b){console.log(b)}}var c=new PETRICHOR.Texture2D;c.image=new Image,a.hasOwnProperty("filter")&&a.filter&&(c.filter=a.filter),a.hasOwnProperty("wrap")&&a.wrap&&(c.wrap=a.wrap),c.image.onload=function(){b(c)},c.image.src=a.path,c.image.complete&&b(c),a.texture=c};var PETRICHOR=PETRICHOR||{};PETRICHOR.FullscreenQuad=function(a){return this.mesh=new PETRICHOR.Mesh,this.mesh.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0],this.mesh.textureCoords=[0,0,1,0,1,1,0,0,1,1,0,1],this.mesh.build(),this.program=new PETRICHOR.Program,a&&(this.program.vertexSrc="precision highp float;\nattribute vec3 aVertex;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n	vTexCoord = aTexCoord;\n	gl_Position = vec4(aVertex, 1.0);\n}",this.program.fragmentSrc="precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main()\n{\n	gl_FragColor = texture2D(uTexture, vTexCoord);\n}",this.program.build(),this.mesh.setAttributeName("vertex","aVertex"),this.mesh.setAttributeName("uv","aTexCoord")),this.setShaders=function(a,b){this.program.vertexSrc=a,this.program.fragmentSrc=b,this.program.build()},this.render=function(a){var b,c,d=PETRICHOR.gl;if(this.program.enable(),a)for(b=0;b<a.length;b++)c=a[b],this.program.setUniform1i(c.sampler,b),d.activeTexture(d.TEXTURE0+b),d.bindTexture(d.TEXTURE_2D,c.id);this.mesh.render(this.program),this.program.disable()},this},PETRICHOR.createCube=function(){var a=new PETRICHOR.Mesh;return a.vertices=[-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,-1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,-1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,1],a.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],a.textureCoords=[0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,1,0,1,1],a.build(),a},PETRICHOR.createUvSphere=function(a,b,c){function d(b,c){var d=1/a;e.vertices.push(b[0]),e.vertices.push(b[1]),e.vertices.push(b[2]),e.normals.push(b[0]*d),e.normals.push(b[1]*d),e.normals.push(b[2]*d),e.textureCoords.push(c[0]),e.textureCoords.push(c[1])}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=Math.sin,w=Math.cos,x=Math.PI,y=x/2;for(e=new PETRICHOR.Mesh,e.vertices=[],e.normals=[],e.textureCoords=[],r=-x/(b-1),s=2*x/(c-1),q=0,n=0;c-1>n;n++){for(p=y,u=q+s,o=0;b-1>o;o++)t=p+r,f=[a*w(p)*w(q),a*v(p),a*w(p)*v(q)],j=[(p+y)/x,q/(2*x)],g=[a*w(t)*w(q),a*v(t),a*w(t)*v(q)],k=[(t+y)/x,q/(2*x)],h=[a*w(t)*w(u),a*v(t),a*w(t)*v(u)],l=[(t+y)/x,u/(2*x)],d(f,j),d(g,k),d(h,l),o>0&&b-1>o&&(i=[a*w(p)*w(u),a*v(p),a*w(p)*v(u)],m=[(p+y)/x,u/(2*x)],d(f,j),d(h,l),d(i,m)),p+=r;q+=s}return e.build(),e},PETRICHOR.renderText=function(a,b,c,d,e,f){var g,h=new PETRICHOR.Texture2D,i=null,j=null;for(i=document.createElement("canvas"),i.id="tmpFontCanvas",i.style.border="none;",i.width=a,i.height=a,j=i.getContext("2d"),j.clearRect(0,0,a,a),j.fillStyle=e,j.strokeStyle=f,j.font=d,g=0;g<b.length;g++)j.fillText(b[g],0,c*(g+1)),f&&j.strokeText(b[g],0,c*(g+1));return h.image=i,h.build(),i=null,h},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),window.clientWidth=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth},window.clientHeight=function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight};var PETRICHOR=PETRICHOR||{};PETRICHOR.width=640,PETRICHOR.height=480,PETRICHOR.mainCanvas=null,PETRICHOR.gl=null,PETRICHOR.init=function(a){function b(){var a=PETRICHOR.width/PETRICHOR.height,b=window.clientWidth(),c=Math.round(window.clientWidth()/a),d={width:b,height:c};return d.height=d.width/a,d.height>c&&(d.height=c-8,d.width=Math.round(d.height*a)),d}function c(){var a=b();PETRICHOR.mainCanvas.style.width=a.width+"px",PETRICHOR.mainCanvas.style.height=a.height+"px",PETRICHOR.mainCanvas.style.position="absolute",PETRICHOR.mainCanvas.style.top=Math.round((window.clientHeight()-a.height)/2)-1+"px",PETRICHOR.mainCanvas.style.left=Math.round((window.clientWidth()-a.width)/2)-1+"px"}function d(a){console.log("Creating canvas..."),PETRICHOR.width=a.width,PETRICHOR.height=a.height,PETRICHOR.mainCanvas=document.createElement("canvas"),PETRICHOR.mainCanvas.id="mainCanvas",PETRICHOR.mainCanvas.style.border="none;",PETRICHOR.mainCanvas.width=PETRICHOR.width,PETRICHOR.mainCanvas.height=PETRICHOR.height,c(),window.onresize=c,document.body.appendChild(PETRICHOR.mainCanvas),console.log("Canvas created.")}function e(){console.log("Creating WebGL context...");try{PETRICHOR.gl=PETRICHOR.mainCanvas.getContext("webgl"),PETRICHOR.gl.viewportWidth=PETRICHOR.mainCanvas.width,PETRICHOR.gl.viewportHeight=PETRICHOR.mainCanvas.height}catch(a){}if(!PETRICHOR.gl)try{PETRICHOR.gl=PETRICHOR.mainCanvas.getContext("experimental-webgl"),PETRICHOR.gl.viewportWidth=PETRICHOR.mainCanvas.width,PETRICHOR.gl.viewportHeight=PETRICHOR.mainCanvas.height}catch(a){}PETRICHOR.gl?console.log("WebGL context created."):window.alert("Could not initialize WebGL, sorry :-(")}d(a),e()},PETRICHOR.resources={textures:{},programs:{},meshes:{},music:null,loadCounter:0},PETRICHOR.setMusic=function(a,b){PETRICHOR.resources.music={ogg:a,mp3:b}},PETRICHOR.addMesh=function(a,b){PETRICHOR.resources.meshes[a]={path:b}},PETRICHOR.addProgram=function(a,b,c){PETRICHOR.resources.programs[a]={vertexPath:b,fragmentPath:c}},PETRICHOR.addTexture=function(a,b,c,d){PETRICHOR.resources.textures[a]={path:b,filter:c,wrap:d}},PETRICHOR.addResources=function(a){var b,c;for(b=0;b<a.length;b++)switch(c=a[b],c.type){case"music":PETRICHOR.setMusic(c.ogg,c.mp3);break;case"mesh":PETRICHOR.addMesh(c.name,c.path);break;case"program":PETRICHOR.addProgram(c.name,c.vertexPath,c.fragmentPath);break;case"texture":PETRICHOR.addTexture(c.name,c.path,c.filter,c.wrap)}},PETRICHOR.loadResources=function(){var a,b;console.log("Loading meshes...");for(a in PETRICHOR.resources.meshes)PETRICHOR.resources.meshes.hasOwnProperty(a)&&(b=PETRICHOR.resources.meshes[a],PETRICHOR.loadMesh(b));console.log("Loading programs...");for(a in PETRICHOR.resources.programs)PETRICHOR.resources.programs.hasOwnProperty(a)&&(b=PETRICHOR.resources.programs[a],PETRICHOR.loadProgram(b));console.log("Loading textures...");for(a in PETRICHOR.resources.textures)PETRICHOR.resources.textures.hasOwnProperty(a)&&(b=PETRICHOR.resources.textures[a],PETRICHOR.loadTexture2D(b));console.log("Loading music..."),PETRICHOR.loadMusic(PETRICHOR.resources.music)},PETRICHOR.isFinishedLoading=function(){return PETRICHOR.resources.loadCounter==countResources()},PETRICHOR.fps={frameTimes:[],currentFrame:0,frameStart:(new Date).getTime(),frameEnd:(new Date).getTime()},PETRICHOR.showFps=function(a){var b,c=0,d=0,e=0;for(PETRICHOR.fps.frameEnd=(new Date).getTime(),d=PETRICHOR.fps.frameEnd-PETRICHOR.fps.frameStart,PETRICHOR.fps.frameStart=PETRICHOR.fps.frameEnd,b=0;b<PETRICHOR.fps.frameTimes.length;b++)e+=PETRICHOR.fps.frameTimes[b];e>=1e3&&(c=(1e3*PETRICHOR.fps.frameTimes.length/e).toFixed(2),document.getElementById(a).innerHTML=c+" fps",PETRICHOR.fps.currentFrame=0,PETRICHOR.fps.frameTimes.length=0),PETRICHOR.fps.frameTimes[PETRICHOR.fps.currentFrame++]=d},PETRICHOR.extensions={},PETRICHOR.getExtension=function(a){var b,c=["","MOZ_","WEBKIT_"],d=null,e=PETRICHOR.gl;if(PETRICHOR.extensions.hasOwnProperty(a))return PETRICHOR.extensions[a];for(b=0;b<c.length&&(d=e.getExtension(c[b]+a),null===d);b++);return PETRICHOR.extensions[a]=d,d};